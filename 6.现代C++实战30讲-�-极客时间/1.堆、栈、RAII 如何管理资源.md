# 堆、栈、RAII 如何管理资源

### 栈-->最自然的内存使用方式

* 本地变量所需要的内存在栈上，和函数需要的数据在一起，当函数执行完成后这些内存就释放了
  * 栈上内存分配简单，移动指针就好
  * 栈上释放也简单，函数执行完移动指针就好
  * 由于先进先出不会有碎片。在堆上分配内存，应为释放的先后不确定会产生碎片。
  * 在栈上对于有析构和构造函数的非基本类型，编译器会在代码合适位置插入构造和析构函数，编译器会自动调用析构函数，并且在代码发生异常时，对象的析构函数也会被执行。

### RAII

* resource acquistion is initializtion 是C++所特有的资源管理方式。C++是唯一一个依赖RAII做资源管理的。
* RAII依托栈和析构函数来对包含堆内存进行管理。
* 在很多情况下对象不应该或者不能在栈上存储
  * 对象很大
  * 对象在编译期大小不确定
  * 对象是函数的返回值，由于特殊原因，不应该使用对象的值返回
    * 常见情况之一是：在工厂方法或者其他面向对象编程的情况下，返回值类型是基类。
* 在析构函数里要做必要的清理工作，这是RAII的基本用法
  * 释放内存
  * 释放同步锁
  * 释放其他重要资源

### 课后讨论

* 全局静态和局部静态都存储在内存静态区，在编译器确定，有固定的存储位置。堆栈上的变量是动态的，地址无法确定。
* thread_local的变量和静态变量存储类型，静态变量是整个程序统一一块，thread_local是一个线程单独一块，应为不共享所以不用同步。